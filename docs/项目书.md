# 浮游动物一体化（Android）项目书（交接用·长期维护）

> 目的：把本项目“做什么、怎么算、怎么导出、代码在哪、怎么封包、怎么迭代”写清楚，方便后续把本文件交给下一个 AI/开发者继续做。

仓库路径：`D:\plankton`  
App 名称：浮游动物一体化  
包名：`com.plankton.one102`  
最低支持：Android 14（API 34）  
当前版本：以 `android/app/build.gradle.kts` 为准（`versionName/versionCode`）  

---

## 1. 项目目标（离线优先）

开发一套可离线使用的移动端工具，用于：

1) **录入**  
- 采样点（名称/点位/水深可自定义；可有垂向分层样品）  
- 每个点位的体积参数：浓缩体积 `V_conc`（mL）、原水体积 `V_orig`（L，默认 20 可改）  
- 物种信息：中文名、拉丁名、分类（5 级）、平均湿重（mg/个）、各点位计数

2) **自动计算**  
- 密度（ind/L）、生物量（mg/L）  
- 多样性指数：Shannon-Wiener `H'`、Margalef `D`、Pielou `J`  
- 优势度 `Y` 与优势种判定（`Y > 0.02`）

3) **导出**  
- 导出两份 `.xlsx`：表1（计数/密度/生物量/H'）与表2（分布/统计/优势度/多样性）  
- **必须模板驱动**：读取 `assets/templates/table1.xlsx`/`table2.xlsx`，按固定坐标填值，保证样式 1:1 复刻

4) **可复核**  
- 应用内提供“预览”（只用于快速核对，最终以导出 `.xlsx` 为准）  
- 预览体验：全屏预览、固定表头、缩放控件，并显示条目数/点位数/统计摘要  
- 缺失项（如缺湿重）有明确提示与可追溯处理入口
- AI 计算核对：内置算法与 API1/API2 交叉核对；**默认内置**，差异时可选结果来源；导出使用最终选择

---

## 2. 核心口径（必须一致）

### 2.1 采样点列（非常重要）

- 采样点列由用户决定：默认 `1、2、3...`；也支持 `1-0、1-2`、`G1` 等。  
- **同一次数据处理中**：表1与表2所有工作表必须使用**同一套采样点列**（同顺序、同名称）。  
- 因此：**点位顺序会直接影响导出列顺序**；应用应允许用户调整点位顺序。

### 2.2 体积参数

- `V_conc`：浓缩体积（mL，按采样点录入）  
- `V_orig`：原水体积（L，默认 20，可逐点修改；导出时需要体现）  
- 导出时：仅在**每个工作簿的第一个工作表**写入“原水体积（L）”这一行（表1首表、表2首表）。  
- 表1首表额外包含“浓缩体积”行（逐点写入）。

### 2.3 平均湿重（mg/个）

- 内置湿重库来自 `表三.xlsx`（已转为 assets `wetweights.json` + Room 自定义覆盖；支持多库切换）。  
- 若查不到：可选双 API 辅助查询（展示两份回答供人工判断），也可直接手动输入。  
- **缺失规则**：若湿重缺失且该物种在某采样点 `count > 0`：  
  - 生物量单元格写 `未查到湿重`  
  - 该点位生物量“总计”也写 `未查到湿重`

### 2.4 公式与边界（按“单个采样点”口径）

密度（公式1，ind/L）：
`ρ = (C / 1.3) * (V_conc / V_orig)`

生物量（公式2，mg/L）：
`B = ρ * W̄`

Shannon-Wiener（公式3）：
`H' = - Σ (p_i * ln(p_i))`

Pielou 均匀度（公式4）：
`J = H' / ln(S)`

Margalef 丰富度（公式5）：
`D = (S - 1) / ln(N)`

优势度（公式6）：
`Y = (n_i / N) * f_i`，`Y > 0.02` 视为优势种

其中（全部是“单个采样点”的口径）：
- `S`：该点位物种数（该点位中 `count>0` 的物种数量）  
- `N`：该点位总个数（该点位所有物种计数之和）  
- `n_i`：该点位第 i 物种计数  
- `f_i`：出现频率 =（该物种出现的采样点数）/（总采样点数），出现判定：`count>0`

边界显示：
- 当 `S<=1` 或 `N<=1` 导致 `ln` 不适用时：`D`/`J` 显示空白  
- `H'` 允许为 0（例如单点位只有一种物种）

---

## 3. 产品结构（页面与功能）

底部主导航（4 Tab）：
- 采样点：点位与体积、分层开关、Excel 导入点位、批量操作、点位顺序（上移/下移/指定序号互换/展开列表长按拖动排序），末尾“下一条”回到第一条  
- 物种：按点位录入计数、物种信息维护、当前点位物种数/计数总和提示（专注录入页同步显示，点位按钮显示各点位统计）、重命名同名自动合并（计数取最大值）、湿重/分类补齐（支持别名/模糊匹配）、批量录入（Excel/语音，AI 解析兼容多返回格式并可查看原始响应，多段 JSON 自动选择可解析候选并提示 type 字段格式，点位/物种名纠错进入待校准列表可手动确认）、**图片识别导入（多图/拍照，涂改无效文字自动忽略；导入时与已有点位/物种自动合并，计数取最大值）**、编辑页关键词联想（含分类字段）、分类编辑弹窗支持本次写入本机库  
- 全局助手浮窗：半透明贴边按钮（全局可见），单输入框（指令/询问）；长按悬浮按钮录音，上滑=指令/下滑=询问，左右滑可取消；录音无需跳转语音助手，直接调用后台转写并回填批量解析；支持功能操作（设置/检测API/AI分析/点位追溯/预览表1/表2/导出表1/表2/数据库树与思维导图/切换手机或平板模式/项目文档），询问/数据查询与助手页互通（含项目文档/更新日志，询问直接调用 API、失败后自动检测；语音/文本支持模糊纠错；回答在浮窗内以卡片收纳，点击查看全文）；面板可直接拖动；内置“语音设置”可选引擎/模型/模式/加速/线程数，并支持切换是否下发配置  
 - 助手：规则检查分级（必须修复/可忽略/提示）+ 一键忽略/恢复、追溯计算过程、补齐缺失项、AI 问答；  
   AI 回答使用富文本排版（标题/列表/表格/有序列表/分数/下标等，清理 LaTeX 符号），并支持自动续写减少截断；问答上下文补齐湿重数据；富文本渲染容错避免闪退  
 - 助手：API 检测状态跨页面保留（避免频繁重复检测）  
 - 助手：API 可用性检测更宽松（任一可用即可启用；双 API 仅在两者都可用时启用）  
 - 助手：AI 任务后台运行，切换页面不清空结果，并提供清除按钮  
- 导出：预导出体检、导出表1/表2（后台任务显示进度/失败原因）与简表（四大类+物种，含计数/密度/生物量/多样性四个 sheet）、预览工作簿、结果图表、统计摘要（含数据版本/完整度）、校验清单、自定义指标导出（CSV）、导出前只读快照、导出时清理模板残留与隐藏列、流式写出 + SAF 原子写入避免 0B、导出拉丁名开关（类/纲/目/科/属/种，可从数据库自定义条目补齐）  
   **AI 计算核对（差异时可选导出来源；差异用表格示意；批量差异审计减少调用次数，失败批次自动拆分/修复）**、AI 报告导出

二级入口（顶部图标）：
- 历史数据集（新建/复制/删除/重命名、备份导入导出、从表1/简表导入、结果对比、只读快照、分页加载）  
- 湿重库（查看内置 + 当前自定义库；支持多库切换）  
- 数据库（分类库/湿重库统一视图 + 导入/清理〔规范导入支持别名列/多别名分隔并自动写入别名库；重复名称自动合并；内置同名湿重默认保留内置〕 + 编辑条目分类关键词联想/弹窗可上下滑动 + 分类树/思维导图；思维导图支持多选同级批量导出）  
- 设置（默认原水体积、API 配置与配置管理、界面模式、数据与缓存、日志与诊断、AI 功能入口开关、物种编辑写库开关、视觉效果透明度、更新日志、项目文档等；项目文档查看需密码，本地解密后显示）

---

## 4. 数据与架构（代码在哪里）

### 4.1 核心数据结构

- `domain/Models.kt`：`Dataset` / `Point` / `Species`（计数按 `pointId -> Int` 存储）  
- `domain/Defaults.kt`：`Settings` / `Taxonomy` 等  

点位顺序 = `Dataset.points` 的列表顺序（导出与预览均按此顺序输出列）。

### 4.2 计算模块

- `domain/Calc.kt`：密度/生物量/H/D/J/Y 等指标计算（全局 + 分点位）  
- 分层（垂向）相关：`domain/buildStratifiedPointGroups`、`calcStratifiedIndices` 等

### 4.3 导出与预览

- 模板：  
  - `android/app/src/main/assets/templates/table1.xlsx`  
  - `android/app/src/main/assets/templates/table2.xlsx`
- 导出实现：`export/ExcelTemplateExporter.kt`（读模板 → 填值 → 保存；大数据流式写出）  
- 后台导出：`export/ExcelExportWorker.kt`（WorkManager；显示进度/失败原因）  
- SAF 写入：`export/SafWriter.kt`（临时文件 + 原子写入，避免 0B）  
- 预览实现：`export/WorkbookPreview.kt` + `ui/dialogs/WorkbookPreviewDialog.kt`（仅核对，不代表最终 Excel 显示）

### 4.4 本机数据库（Room，自定义覆盖）

- 湿重：`data/db/WetWeightEntity.kt` + `data/repo/WetWeightRepository.kt`（内置 JSON + 自定义覆盖）  
- 分类覆盖：`data/db/TaxonomyEntity.kt` + `data/repo/TaxonomyOverrideRepository.kt`  
- 统一条目视图：`ui/DatabaseViewModel.kt` 合并内置/自定义来源

### 4.5 可选 AI（OpenAI 兼容）

- `data/api/ChatCompletionClient.kt`：OpenAI 兼容 Chat Completions  
- 提示词：`domain/WetWeightPrompts.kt` / `domain/TaxonomyPrompts.kt` 等  
- 约束：AI 仅做辅助，必须展示可追溯信息，最终以人工确认/手动输入为准
- 计算核对：`data/api/CalcVerification.kt` + `domain/CalcDiff.kt`（内置 vs API 的差异比对；大数据量自动分点位分批输出）  
- 图片识别导入：`data/api/AiImageImport.kt` + `importer/ImageImportUtils.kt`（视觉模型解析纸面计数；高分辨率+切片）

### 4.6 独立语音助手接入（Whisper / Sherpa）

定位：将语音识别与指令解析做成独立 App（语音助手），主 App 只负责执行动作。  
独立 App 项目书：`docs/语音助手项目书.md`（必须同步维护）。  
说明：语音助手支持 Whisper（Vulkan GPU 可开关）与 Sherpa（流式：zipformer 中文/zipformer bilingual；高精度：sense-voice/paraformer，NNAPI 可开关），并提供快速/准确模式、自动策略、长音频 VAD 分段与 16kHz 预处理；Whisper 模型仅保留 `small-q8_0`。主 App 可在全局助手里下发引擎/模式/加速/线程参数（含 Sherpa 模型选择）。  
补充：多线程线程数可选（自动/1/2/4/6/8），录音格式可选 M4A/WAV（分析前自动解码），支持音频缓存一键清除；界面采用玻璃拟态+柔和渐变风格，设置页提供毛玻璃/高斯模糊开关，并适配高刷新率屏幕。  
Android 11+ 包可见性：主 App 需在 Manifest 增加 `<queries>` 声明 `com.voiceassistant`，否则会提示“未安装语音助手”。  
新增：提供后台转写服务 `ACTION_TRANSCRIBE_AUDIO`，主 App 可不跳转语音助手界面直接调用。  
新增：后台转写支持 `CANCEL_TRANSCRIBE_AUDIO` 取消请求。  

接入方式（Intent v1）：
- 主 App 显式启动语音助手 Action：`com.voiceassistant.action.REQUEST_BULK_COMMAND`
- 语音助手完成识别后，回调主 App 并返回 raw_text/bulk_json
- 主 App 收到后优先用 raw_text 调用本地 API 解析与纠错校准；bulk_json 作为兜底

主 App → 语音助手（请求）：
```text
action = com.voiceassistant.action.REQUEST_BULK_COMMAND
extras:
  request_id      : String(UUID)
  input_type      : "voice" | "text"
  input_text      : String (input_type=text)
  template        : "general" | "counts"
  context_uri     : String(content://... context.json)
  return_action   : String(主 App 接收结果的 Action)
  return_package  : String(主 App 包名)
  require_confirm : Boolean
```

语音助手 → 主 App（结果回传）：
```text
action  = return_action
package = return_package
extras:
  request_id   : String
  status       : "ok" | "error" | "cancel"
  bulk_json    : String(结构化指令 JSON)
  raw_text     : String(ASR 原文，可为空)
  raw_api      : String(API 原始响应，可选)
  audio_path   : String(content://... 音频 Uri，可选)
  warnings     : String(提示，可选)
  error_message: String(失败原因，可选)
```

后台转写（主 App 直接调用，不打开语音助手界面）：
```text
action = com.voiceassistant.action.TRANSCRIBE_AUDIO
extras:
  request_id     : String(UUID)
  audio_uri      : String(content://... 音频 Uri)
  return_action  : String(主 App 接收结果的 Action)
  return_package : String(主 App 包名)
  engine         : "whisper" | "sherpa_streaming" | "sherpa_offline"（可选）
  model_id       : String（Whisper 模型，可选）
  decode_mode    : "fast" | "accurate"（可选）
  use_gpu        : Boolean（Whisper，可选）
  auto_strategy  : Boolean（Whisper，可选）
  use_multithread: Boolean（可选）
  thread_count   : Int（0=自动，可选）
  sherpa_provider: "cpu" | "nnapi"（Sherpa，可选）
  sherpa_streaming_model: "zipformer_zh" | "zipformer_bilingual"（Sherpa 流式，可选）
  sherpa_offline_model  : "sense_voice" | "paraformer_zh"（Sherpa 高精度，可选）
```

取消转写（主 App 发送）：
```text
action = com.voiceassistant.action.CANCEL_TRANSCRIBE_AUDIO
extras:
  request_id     : String(UUID)
  return_action  : String(主 App 接收结果的 Action)
  return_package : String(主 App 包名)
```

Context JSON（主 App 生成，用于消歧）：
```json
{
  "dataset_id": "uuid",
  "active_point": "1-0.3",
  "points": ["1-0.3", "1-5", "2-0.3"],
  "species": ["无节幼体", "桡足类"],
  "aliases": [
    { "alias": "无节幼体", "canonical": "无节幼体" }
  ]
}
```

bulk_json（语音助手输出，主 App 解析执行）：
```json
{
  "actions": [
    { "type": "point.add", "point": "4", "vc": 57, "vo": 20 },
    { "type": "count.set", "point": "4", "species": "无节幼体", "value": 5 }
  ],
  "unparsed": [],
  "notes": [],
  "warnings": []
}
```

安全建议（开放第三方接入）：
- 不使用 signature 权限，改为**用户确认 + 授权白名单**
- 首次接入弹窗确认包名/签名摘要/请求内容，并支持“仅一次/总是允许/拒绝”
- 设置页提供已授权列表与一键撤销

---

## 5. 构建、封包与迭代规则（必须遵守）

### 5.1 构建命令（Windows PowerShell）

```powershell
$env:JAVA_HOME='D:\plankton\.toolchain\jdk\jdk-17.0.13+11'
$env:PATH="$env:JAVA_HOME\bin;$env:PATH"
cd D:\plankton\android
.\gradlew.bat :app:assembleDebug
```

输出 APK：
- `D:\plankton\android\app\build\outputs\apk\debug\app-debug.apk`

### 5.2 每次封包必须“备份旧包”

本仓库已在 `android/app/build.gradle.kts` 配置：每次 `assembleDebug` 后会自动复制并归档到：
- `D:\plankton\apk_history\debug\app-debug-v<versionName>(<versionCode>).apk`

### 5.3 版本与更新日志（做任何功能/行为变更都要同步）

每做一个版本（功能/行为变更）必须同步更新：
1) `android/app/build.gradle.kts`：`versionName/versionCode`  
2) `android/app/src/main/java/com/plankton/one102/ui/AppInfo.kt`：更新日志（设置页展示）  
3) `docs/当前程序情况.md`：版本号与说明同步  
4) 构建 Debug APK（确保归档成功）

另外：本文件 `docs/项目书.md` 也要补充新增功能与注意事项，保证可交接。

### 5.4 任务清单读取规则（防止重复任务）

- 用户可能在仓库内创建“任务清单”文件夹（名称含“任务清单”），任务会以**数字命名的独立文件**持续更新。  
- **默认以对话框任务为准**；只有用户明确强调“读取任务清单/按任务清单执行”时才读取该文件夹。  
- 读取任务清单时：**永远只做最新的数字文件**，忽略旧文件，避免重复执行。  
- 任务文件为**单次任务**，无需结合旧文件。  

---

## 6. 交接清单（给下一个 AI/开发者）

开始开发前先读：
- `docs/项目书.md`（本文件，最新）  
- `docs/当前程序情况.md`（当前版本实现与索引）  
- `docs/原生安卓项目书.md`（需求确认稿，范围/导出规范）  

做改动时优先遵循：
1) “核心口径”不变（公式、边界、湿重缺失规则、点位列一致）  
2) “模板驱动导出”不变（不要尝试纯代码重建样式）  
3) “每次封包归档 + 更新日志”必须做
