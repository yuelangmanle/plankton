# 浮游动物一体化（原生 Android）项目书

版本：v0.1（需求确认稿，当前 App 版本 6.1）  
应用名：**浮游动物一体化**  
包名：`com.plankton.one102`  
最低支持：Android 14（API 34，Android SDK 版本号）  
优先适配：Android 16（全面屏手势/沉浸式）  
导出要求：必须生成 `.xlsx`，且包含多个工作表（与现有表1/表2一致）  
分享要求：表1/表2 **分别**提供分享按钮

---

## 1. 背景与目标
本项目用于浮游动物数据的移动端录入、自动计算与 Excel 导出，面向野外/实验室人员，核心目标是：
- **快速录入**：按采样点逐条输入体积与计数，适配手机触控操作。
- **自动计算**：密度、生物量、多样性指数与优势度等指标自动输出。
- **可复核导出**：导出与示例表一致结构的 `.xlsx`（多 sheet），便于直接提交/汇总。
- **可扩展湿重库**：支持用户新增表三中没有的平均湿重条目，并可增删改，长期保存。

## 2. 范围与不做事项
### 2.1 本期必做
- 采样点录入（名称、浓缩体积、原水体积，默认原水体积 20 L 可改）
- 物种录入（中文名、拉丁名、分类 5 列、平均湿重 mg/个、各采样点计数）
- 分类编辑弹窗：支持本次编辑写入自定义分类库
- 专注录入：点位按钮显示物种数与计数总和
- 平均湿重库：内置表三 + 自定义条目（持久化，可增删改）
- 数据集管理：历史列表（新建/重命名/复制/删除）+ 备份导入/导出（JSON）
- 计算：密度、生物量、H’、D、J、优势度 Y 与优势种判定
- 导出：表1/表2 两份 `.xlsx`（各含多个 sheet），并分别支持分享
- 设置：默认原水体积、双 API 配置（可选用；回答需“有理有据”）、API 配置管理与快速切换
- AI 功能：任务后台运行、结果持久化（切换页面不清空）、提供进度提示与清除按钮
- 全局助手浮窗：半透明贴边按钮，支持文本输入与语音录音/暂停/停止，默认调用语音助手后台转写（可跳转语音助手 App）；支持功能操作（设置/检测API/AI分析/点位追溯/导出表1/表2）与询问/数据查询（含项目书/更新日志），面板可直接拖动
- 导出拉丁名：按类/纲/目/科/属/种开关可选；纲/目/科/属缺失时可从数据库自定义条目补齐

### 2.2 本期暂不做（可后续扩展）
- 云同步/账号体系
- 复杂权限管理（本期仅使用系统文件选择器与分享面板）

## 3. 关键业务规则（与现有 Web 原型保持一致）
### 3.1 采样点与列
- 采样点列数由用户新增决定；点位名称可自定义（默认 `1,2,3…`，也可 `1-0, 1-2, G1…`）。
- 原水体积 `V_orig` 默认 `20 L`，允许逐点修改，且“默认值”可在设置里修改。

### 3.2 湿重缺失规则
- 若某物种在某点位 **计数 > 0** 且 **平均湿重缺失**：
  - 生物量单元格输出：`未查到湿重`
  - 该点位生物量“总计”输出：`未查到湿重`

### 3.3 多样性与优势度公式（按你确认的顺序与含义）
以“每个点位”为单位计算：
- **总个数**：`N = Σ ni`（该点位所有物种计数之和）
- **物种数**：`S = 该点位出现的物种数`（注意：不是全站点）
- **Shannon-Wiener**：`H' = - Σ (pi * ln(pi))`，`pi = ni / N`
- **Pielou 均匀度**：`J = H' / ln(S)`
- **Margalef 丰富度**：`D = (S - 1) / ln(N)`（这里的 `N` 为“总个数”，不是密度）
- **优势度**：`Y = (ni / N) * fi`（`fi` 为该物种在所有点位的出现频率）
  - 优势种判定：`Y > 0.02`

边界处理（按你确认的显示规则）：
- 若 `S <= 1` 或 `N <= 1`，则 `J`、`D` 显示空白

### 3.4 密度与生物量
（与现有原型一致）
- **密度**：`density = (count / 1.3) * (V_conc / V_orig)`  
  - `V_conc` 单位 mL；`V_orig` 单位 L
- **生物量**：`biomass = density * wetWeightMg`

## 4. Excel 导出规格
### 4.1 产物
导出两份文件，各自包含多个工作表：
- **表1.xlsx**
  - `浮游动物计数`
  - `浮游动物密度`
  - `浮游动物生物量`
  - `浮游动物多样性指数H'表`
- **表2.xlsx**
  - `浮游动物采样点物种分布图`
  - `浮游动物密度统计表`
  - `浮游动物生物量统计表`
  - `浮游动物优势度`
  - `浮游动物多样性表`

### 4.2 “原水体积”行位置（你已确认）
- 表1：仅第一个 sheet（计数）包含“原水体积（L）”行，其余 sheet 不包含
- 表2：仅第一个 sheet（分布图）包含“原水体积（L）”行，其余 sheet 不包含

### 4.3 分享按钮（你已确认）
- 表1、表2 **分别**有“保存/导出”和“分享”入口

### 4.4 样式复刻（你已确认：严格 1:1）
- 以你提供的 `表1.xlsx`、`表2.xlsx` 为**模板**严格复刻：工作表名称、单元格合并、列宽/行高、字体/颜色、对齐、边框、底色、冻结窗格、突出显示等均以模板为准。
- 导出实现采用“读模板 → 按固定坐标填值 → 保存为新文件”，避免手工重建样式导致偏差。

### 4.5 预览要求（新增）
- 应用内预览需全屏展示
- 表头固定（滚动时仍可看到表头）
- 提供缩放控件（滑条 + 放大/缩小）
- 预览区显示条目数/点位数/统计摘要

## 5. UI/交互设计（手机优先）
### 5.1 导航结构
- 底部 3 个主 Tab：
  1) 采样点与体积  
  2) 物种与计数  
  3) 预览与导出

### 5.2 采样点录入（顺序录入）
- 默认先显示第一条采样点
- 录入“浓缩体积（mL）”后可一键跳到下一条：
  - 点击“下一条”或键盘“下一步”
  - 若到末尾则回到第一条（不自动新增）
- 保留“快速切换”入口，允许手动上下跳转

### 5.3 物种与计数（触控友好）
- 建议按“当前采样点”逐个录入计数：顶部点位切换（Chip）
- 每个物种用卡片呈现：
  - 大号 `+ / −` 按钮 + 数字输入框（适配触控）
  - 展开编辑：中文名/拉丁名/分类 5 列/平均湿重

### 5.4 全面屏与沉浸式（Android 16 优先）
- 启用 edge-to-edge
- 使用 `WindowInsets` 处理状态栏/导航栏安全区
- 所有底部按钮/Tab 避免被手势条遮挡

## 6. 数据与持久化设计
### 6.1 数据集（当前 + 历史列表）
- 本地持久化保存（退出/重进不丢）
- 数据结构：标题前缀、采样点列表、物种列表、计数矩阵、时间戳等
- 历史列表：支持新建/重命名/复制/删除；进入应用可选择继续上次或从历史进入
- 备份：导出/导入 JSON（用于换机/分享/存档）

### 6.2 自定义湿重库（持久化数据库）
字段（最小集合）：
- 中文名（唯一键）
- 拉丁名（可空）
- 平均湿重（mg/个）
- 分类辅助字段（大类/亚类，可空，用于搜索与自动补齐）

规则：
- 自定义条目与表三同名时，优先使用自定义条目

## 7. 技术方案（原生 Android）
### 7.1 技术栈
- Kotlin + Jetpack Compose（Material 3）
- 架构：MVVM + Repository + UseCase（保证计算与导出可单测）
- 本地存储：
  - Room：自定义湿重库
  - DataStore（或本地文件 JSON）：当前数据集与设置
- 网络：OkHttp/Ktor（用于双 API 查询湿重，可选）

### 7.2 `.xlsx` 生成方案（重点）
目标：可在 Android 14+ 离线生成多 sheet `.xlsx`，并**严格 1:1 复刻模板样式**。
实现策略：
1) **模板驱动导出（推荐）**：将 `表1.xlsx`、`表2.xlsx` 作为 assets 模板，运行时复制为工作簿并按固定坐标填值；样式、合并、列宽等由模板保证一致。  
2) 纯代码重建样式：实现成本高且容易与模板不一致（本期不建议）。

技术选型：优先评估可在 Android 14+ 正常运行的 xlsx 读写库以支持“读模板 + 写值”。

### 7.3 文件保存与分享
- 保存：Storage Access Framework（让你选择目录与文件名，满足“路径你决定”）
- 分享：系统分享面板（`ACTION_SEND`），对表1/表2分别提供分享按钮

### 7.4 双 API 湿重查询（有理有据）
定位：仅作为“辅助查询”，结果以你最终选择/录入为准。

交互：
- 同时调用 API 1 & API 2，展示两份完整回答
- 从回答中提取可能的数值候选，供你一键选用
- 支持“一键保存到自定义湿重库”（可选）

提示词约束（示例模板）：
- 目标：请**精确考证**“{中文名}（{拉丁名}）”的平均湿重，单位 mg/个
- 输出必须包含：
  1) 推荐值（mg/个）与可选范围（如有）
  2) 依据/推导（样本来源、个体大小/干湿重换算、测量条件等，能说明为什么是这个值）
  3) 可核对来源：至少 1 条可检索信息（论文/书籍/数据库的 DOI/ISBN/URL 或完整引文）
  4) 若无可靠来源：明确说明“不确定/未找到可靠数据”，不要编造来源

## 8. 视觉规范（来自你提供的第二张图）
建议主色与辅色（可在实现时微调对比度以满足可读性）：
- Aqua Blue：`#A8D8E0`（主色/背景）
- Slate Blue：`#8DA9C4`（次色/按钮）
- Mint Green：`#BCE3C5`（成功/提示）
- Soft Yellow：`#F8E8A0`（警告/强调）
- Pale Orange：`#F4C7A8`（次级强调）

图标来源：`assets/icon.png`（将制作 adaptive icon 与各尺寸 mipmap）

## 9. 里程碑与交付
建议拆分为 6 个里程碑（每阶段都可运行）：
1) 工程搭建 + edge-to-edge + 三页骨架
2) 数据录入（采样点/物种/计数）+ 本地保存（当前数据集）
3) 历史数据集列表 + 备份导入/导出（JSON）
4) 计算模块 + 预览页
5) 湿重库（表三内置 + 自定义增删改）+ 自动补齐 + 双 API 辅助
6) Excel 导出（表1/表2，模板 1:1）+ 两份分享 + UI 打磨

交付物：
- 源码工程（Android Studio 可打开）
- Debug APK（自测用）
- Release AAB/APK（签名与上架按你的需求再定）

## 10. 风险与对策
- **Excel 读模板库体积/内存**：可能偏大 → 先以可用与 1:1 为先；必要时再做体积优化或更换库
- **大数据量性能**：点位/物种过多时导出耗时 → 导出放后台线程，提供进度与可取消
- **API 回答可靠性**：可能出现不确定或来源不可核对 → 强制展示原文与来源字段，默认不自动写入；你确认后才可保存到湿重库
- **API Key 安全**：仅本地存储，不上传；提供一键清除；支持不启用 API 的纯手动流程

---

## 11. 独立语音助手接入（与主 App 对接）

目标：把语音识别与指令解析做成**独立 App**，主 App 只负责执行动作。  
语音助手项目书：`docs/语音助手项目书.md`。  
说明：语音助手支持 Vulkan GPU 加速（可开关，失败自动回退 CPU），并提供快速/准确模式、自动策略、长音频 VAD 分段与 16kHz 预处理。  
补充：多线程线程数可选（自动/1/2/4/6/8），录音格式可选 M4A/WAV（分析前自动解码），后台转写支持取消。  
Android 11+ 包可见性：主 App 需在 Manifest 增加 `<queries>` 声明 `com.voiceassistant`，否则会提示“未安装语音助手”。  

接入协议（Intent v1）：
说明：主 App 收到回调后优先使用 raw_text 调用本地 API 解析与纠错校准；bulk_json 作为兜底。

主 App → 语音助手（请求）：
```text
action = com.voiceassistant.action.REQUEST_BULK_COMMAND
extras:
  request_id      : String(UUID)
  input_type      : "voice" | "text"
  input_text      : String (input_type=text)
  template        : "general" | "counts"
  context_uri     : String(content://... context.json)
  return_action   : String(主 App 接收结果的 Action)
  return_package  : String(主 App 包名)
  require_confirm : Boolean
```

语音助手 → 主 App（回调结果）：
```text
action  = return_action
package = return_package
extras:
  request_id   : String
  status       : "ok" | "error" | "cancel"
  bulk_json    : String(结构化指令 JSON)
  raw_text     : String(ASR 原文，可为空)
  raw_api      : String(API 原始响应，可选)
  audio_path   : String(content://... 音频 Uri，可选)
  warnings     : String(提示，可选)
  error_message: String(失败原因，可选)
```

后台转写（主 App 直接调用，不打开语音助手界面）：
```text
action = com.voiceassistant.action.TRANSCRIBE_AUDIO
extras:
  request_id     : String(UUID)
  audio_uri      : String(content://... 音频 Uri)
  return_action  : String(主 App 接收结果的 Action)
  return_package : String(主 App 包名)
```

取消转写（主 App 发送）：
```text
action = com.voiceassistant.action.CANCEL_TRANSCRIBE_AUDIO
extras:
  request_id     : String(UUID)
  return_action  : String(主 App 接收结果的 Action)
  return_package : String(主 App 包名)
```

Context JSON（主 App 生成）：
```json
{
  "dataset_id": "uuid",
  "active_point": "1-0.3",
  "points": ["1-0.3", "1-5", "2-0.3"],
  "species": ["无节幼体", "桡足类"],
  "aliases": [
    { "alias": "无节幼体", "canonical": "无节幼体" }
  ]
}
```

bulk_json（语音助手输出）：
```json
{
  "actions": [
    { "type": "point.add", "point": "4", "vc": 57, "vo": 20 },
    { "type": "count.set", "point": "4", "species": "无节幼体", "value": 5 }
  ],
  "unparsed": [],
  "notes": [],
  "warnings": []
}
```

安全建议（开放第三方接入）：
- 不使用 signature 权限，改为**用户确认 + 授权白名单**
- 首次接入弹窗确认包名/签名摘要/请求内容，并支持“仅一次/总是允许/拒绝”
- 设置页提供已授权列表与一键撤销

---

## 已确认
- 需要“历史数据集列表/导入导出备份”
- Excel 样式严格 1:1 复刻示例表（模板驱动导出）

