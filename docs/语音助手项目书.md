# 语音识别助手（独立 App）项目书

版本：v3.2  
应用名：**语音识别助手**  
包名：`com.voiceassistant`  
最低支持：Android 14（API 34）  
定位：独立悬浮语音助手 + 语音转文本 + 固定格式指令输出  

---

## 1. 目标与边界

目标：
- 点击录音 → 语音转文本（whisper.cpp） → 解析为结构化指令 → 发送给“浮游动物一体化”
- 提供全局悬浮入口（不需要进入主 App 也能说话）
- 允许选择模型（Whisper 仅保留 `small-q8_0`）

边界：
- 只负责语音转文本与指令整理；**最终执行**由主 App 完成
- 不做账号系统/云同步
- 不做跨 App 的自动化操作（除非未来显式引入无障碍）

---

## 2. 核心功能

- 悬浮窗入口（可开/关）
- 点击录音（开始/暂停/继续/停止）
- 导入音频分析（本地文件）
- 分析进度条与任务队列
- 处理模式（排队 / 并发二选一）
- 引擎选择：Whisper / Sherpa（流式：zipformer 中文/zipformer bilingual；高精度：sense-voice/paraformer）
- GPU 加速（Vulkan，可开关，失败自动回退 CPU）
- NNAPI 加速（Sherpa，可开关，失败自动回退 CPU）
- 多线程加速开关（可切单线程降低资源占用）
- 多线程线程数可选（自动/1/2/4/6/8）
- 快速/准确识别模式（greedy/beam）
- 自动策略（按设备与音频长度自动选模型/GPU）
- 长音频 VAD 分段转写（20–30s）与流式更新
- 转写前统一降采样到 16kHz 单声道
- 录音格式可选（M4A/WAV，分析前自动解码）
- “保存模型设置”按钮（模型切换需保存）
- “开始分析”按钮（不再自动分析）
- 转写结果自动转为简体中文
- 转写结果自动补标点并按任务分开展示（完成后补标点）
- 转写结果一键清除
- 音频缓存一键清除（录音/导入/解码/分段）
- 界面风格：玻璃拟态 + 柔和渐变（可关闭以提升性能）
- 录音前后缓冲（预热跳过 + 尾部补零，提升短句识别稳定性）
- 状态栏沉浸与手势返回适配（设置页手势返回不退出）
- 项目书弹窗/文档背景加厚，玻璃效果更清晰
- 高刷新率屏幕适配（优先使用更高刷新率）
- 设置页（视觉效果开关：毛玻璃/高斯模糊；透明度调节；项目书/更新日志，项目书访问需密码，本地解密后显示）
- 后台转写支持取消
- 支持转写任务取消
- 后台转写支持按请求覆盖引擎/模式/加速/线程参数
- ASR 模型选择（`small-q8_0`）
- 语音自动转写（中英文/自动）
- 结果预览与确认（显示将要执行的动作清单）
- 一键发送到主 App（可带文本或仅回传音频；接入请求默认回传转写文本）

---

## 3. 模型策略

模型类型（Whisper）：`small-q8_0`（多语言，量化 q8_0）  
使用策略（Whisper）：
- 默认 `small-q8_0`（已移除 q5 档位）
- 长音频自动启用 VAD 分段（20–30 秒）并流式更新
- 快速模式固定语言（中文或英文），准确模式允许自动识别
- 自动策略会按 RAM/SoC + 音频长度调整模型与 GPU 使用
- 运行前进行内存检查，避免低内存设备崩溃
- 模型已内置打包进 APK；首次使用会自动复制到：
  - 内部：`/data/data/com.voiceassistant/files/models/`
  - 外部覆盖（可选）：`/Android/data/com.voiceassistant/files/models/`
- 注意：内置模型会显著增大安装包体积

Sherpa（可选引擎）：
- 流式：zipformer（中文）/ zipformer bilingual（中英）
- 高精度：sense-voice（多语）/ paraformer（中文）
- 模型内置在 `assets/sherpa/`，无需复制到本地
- NNAPI 仅在支持机型启用，失败自动回退 CPU
- sense-voice 的“准确模式”会自动降级为稳定模式（避免闪退）

---

## 4. 权限与系统限制

必须权限：
- `RECORD_AUDIO`（录音）
- `FOREGROUND_SERVICE` + `FOREGROUND_SERVICE_MICROPHONE`（后台录音）
- `FOREGROUND_SERVICE_DATA_SYNC`（后台转写）
- `SYSTEM_ALERT_WINDOW`（悬浮窗）

建议权限：
- `POST_NOTIFICATIONS`（显示录音/识别状态）

注意：
- 部分系统会限制后台录音与悬浮窗存活，需提供引导说明

---

## 5. 交互流程（核心链路）

1) 悬浮按钮 → 点击开始录音  
2) 录音结束或导入音频 → 手动点击“开始分析”  
3) whisper.cpp 转文本 → 文本解析 → 结构化指令  
4) 预览确认 → 发送到主 App 执行  

---

## 6. 对外接口与接入方法（v1）

### 6.1 Intent 接入（推荐）

主 App → 语音助手 App（显式启动）：

Action：`com.voiceassistant.action.REQUEST_BULK_COMMAND`

Extras：
- `request_id`：String（UUID）
- `input_type`：`"voice"` / `"text"`
- `input_text`：String（当 input_type=text）
- `template`：`"general"` / `"counts"`
- `context_uri`：String（Context JSON 的 content Uri）
- `return_action`：String（主 App 接收结果的 Action）
- `return_package`：String（主 App 包名）
- `require_confirm`：Boolean（是否强制预览确认）

语音助手 App → 主 App（显式回调）：

Action：`return_action`  
Package：`return_package`

Extras：
- `request_id`：String
- `status`：`"ok"` / `"error"` / `"cancel"`
- `bulk_json`：String（结构化指令 JSON）
- `raw_text`：String（ASR 文本）
- `raw_api`：String（原始 API 响应，可选）
- `audio_path`：String（content:// 音频 Uri，用于主 App 读取音频；可与 raw_text 同时或单独回传）
- `warnings`：String（提示，可选）
- `error_message`：String（失败原因，可选）

说明：接入请求默认回传 `raw_text`，如需仅回传音频可在语音助手侧关闭。

### 6.2 后台转写（不打开语音助手界面）

主 App → 语音助手后台转写服务：

Action：`com.voiceassistant.action.TRANSCRIBE_AUDIO`

Extras：
- `request_id`：String（UUID）
- `audio_uri`：String（content:// 音频 Uri）
- `return_action`：String（主 App 接收结果的 Action）
- `return_package`：String（主 App 包名）
- `engine`：`whisper` / `sherpa_streaming` / `sherpa_offline`（可选）
- `model_id`：String（Whisper 模型，可选）
- `decode_mode`：`fast` / `accurate`（可选）
- `use_gpu`：Boolean（Whisper，可选）
- `auto_strategy`：Boolean（Whisper，可选）
- `use_multithread`：Boolean（可选）
- `thread_count`：Int（0=自动，可选）
- `sherpa_provider`：`cpu` / `nnapi`（Sherpa，可选）
- `sherpa_streaming_model`：`zipformer_zh` / `zipformer_bilingual`（Sherpa 流式，可选）
- `sherpa_offline_model`：`sense_voice` / `paraformer_zh`（Sherpa 高精度，可选）

回调结果同 6.1（status/raw_text/audio_path 等）。

说明：主 App 可在全局助手悬浮按钮长按录音时调用本接口，上滑=指令、下滑=询问，识别结果回传后由主 App 决定解析与执行。

取消转写（主 App 发送）：

Action：`com.voiceassistant.action.CANCEL_TRANSCRIBE_AUDIO`

Extras：
- `request_id`：String（UUID）
- `return_action`：String（主 App 接收结果的 Action）
- `return_package`：String（主 App 包名）

返回：
- `status = "cancel"`，`error_message = "已取消转写"`

安全建议（开放第三方接入）：
- 不使用 signature 权限，改为**用户确认 + 授权白名单**
- 首次接入必须弹窗确认：显示调用包名/签名摘要/请求内容
- 提供“仅一次 / 总是允许 / 拒绝”选项
- 在设置页提供“已授权列表”与一键撤销

### 6.2 Context JSON 结构（主 App 生成）

```json
{
  "dataset_id": "uuid",
  "active_point": "1-0.3",
  "points": ["1-0.3", "1-5", "2-0.3"],
  "species": ["无节幼体", "桡足类"],
  "aliases": [
    { "alias": "无节幼体", "canonical": "无节幼体" }
  ]
}
```

### 6.3 指令 JSON 结构（bulk_json）

```json
{
  "actions": [
    { "type": "point.add", "point": "4", "vc": 57, "vo": 20 },
    { "type": "count.set", "point": "4", "species": "无节幼体", "value": 5 }
  ],
  "unparsed": [],
  "notes": [],
  "warnings": []
}
```

### 6.4 版本协商

- 在 `bulk_json` 外层可扩展 `schema_version`（例如 `"v1"`, `"v2"`）
- 主 App 需支持最低 `v1`，未来升级保持向后兼容

---

## 7. 与“浮游动物一体化”的接入方式（主 App 视角）

1) 在主 App 批量录入页提供“语音助手”入口  
2) 生成 Context JSON 并通过 `FileProvider` 共享给语音助手  
3) 通过 `REQUEST_BULK_COMMAND` 发起识别  
4) 接收 raw_text/bulk_json 后自动用主 App API 解析与纠错，并进入“解析预览”流程  
5) 全局助手可直接调用 `TRANSCRIBE_AUDIO` 后台转写，无需跳转到语音助手界面  

---

## 8. 未来扩展

- 提供公开接口（需要用户确认）给其它 App 接入  
- 支持更多解析模板（如“物种名修正模板/湿重补齐模板”）
- 如需跨 App 自动操作，需额外评估无障碍服务与合规风险

---

## 9. 构建与更新规则

构建（Windows PowerShell）：

```powershell
$env:JAVA_HOME='D:\plankton\.toolchain\jdk\jdk-17.0.13+11'
$env:PATH="$env:JAVA_HOME\bin;$env:PATH"
$env:CMAKE_BUILD_PARALLEL_LEVEL=1
cd D:\plankton\voice_assistant
.\gradlew.bat :app:assembleDebug
```

APK 输出：
- `D:\plankton\voice_assistant\app\build\outputs\apk\debug\app-debug.apk`
- 历史归档：`D:\plankton\voice_assistant\apk_history\debug\voice-assistant-debug-v<versionName>(<versionCode>).apk`

Release（性能测试）：

```powershell
.\gradlew.bat :app:assembleRelease
```

Release 输出：
- `D:\plankton\voice_assistant\app\build\outputs\apk\release\app-release.apk`
- 历史归档：`D:\plankton\voice_assistant\apk_history\release\voice-assistant-release-v<versionName>(<versionCode>).apk`

更新日志维护：
- `voice_assistant/app/src/main/java/com/voiceassistant/ui/AppInfo.kt`

