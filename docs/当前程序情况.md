# 浮游动物一体化（原生安卓）当前程序情况说明

本文档用于在一个窗口内快速、完整地了解当前程序做到了什么、怎么用、数据怎么流转、代码结构在哪里、以及后续迭代应注意什么。

## 1. 基本信息

- 应用名：浮游动物一体化
- 包名：`com.plankton.one102`
- 最低支持：Android 14（API 34）；优先适配 Android 16
- 当前版本：`6.1`（`versionCode=610`）
- UI：Jetpack Compose + Material3（支持手机/平板模式）
- 刷新率：自动适配设备高刷新率模式（若屏幕支持）
- APK（debug）：`d:\plankton\android\app\build\outputs\apk\debug\app-debug.apk`
- APK 历史归档（debug）：`d:\plankton\apk_history\debug\app-debug-v<versionName>(<versionCode>).apk`

## 2. 关键入口与使用流程（从录入到导出）

### 2.1 采样点（Tab：采样点）

用途：录入每个采样点的名称、浓缩体积（mL）、原水体积（L，默认 20 可改）。

支持：
- 手动新增/删除采样点
- 调整采样点顺序（上移/下移，影响导出列顺序）
- 点位排序：可输入序号与当前点位互换位置
- 快速切换：支持展开列表；长按拖动排序（拖动时其他点位避让，靠近边缘自动滚动）
- 多选拖动：可勾选多个点位一起拖动排序
- 顺序录入：点击“下一条”到末尾时回到第一条（不自动新增）
- 分层计算（可选）：
  - 适用：同一站位不同水深样品（例如 `1-0.3` 表示 1 号点位 0.3m）
  - 点位名结构化：分层模式下按“点位 + 水深(m)”两栏编辑与保存（不再依赖字符串解析）
  - 可设置：上/中/下层水深范围（m）
  - 导出：表2 会额外生成分层汇总表（多样性/密度/生物量/优势度-优势种清单）
- Excel 一键导入采样点（.xlsx，第 1 个工作表）：
  - 第 1 列：采样点名称
  - 第 2 列：浓缩体积（mL）
  - 第 3 列：原水体积（L，空白则用默认值）
- 批量操作（当前点参数复制到全部点位、应用默认原水体积到全部点位、清空全部浓缩体积）

### 2.2 物种与计数（Tab：物种）

用途：按采样点录入各物种计数，并维护物种信息（分类、拉丁名、平均湿重）。

支持：
- 采样点切换：顶部点位按钮
- 当前点位提示：显示本点物种数与计数总和
- 物种分组：按四大类（原生动物/轮虫类/枝角类/桡足类/未分类）
- 计数录入：整页可滑动到底；点击物种卡片的“计数”可手动输入（专注录入用于现场快速 +/-）
- 批量操作：
  - 清空当前点计数
  - 清空全部计数
  - 合并同名物种（中文名相同的条目合并，计数求和，尽量保留非空分类/拉丁名/湿重）
  - 用当前物种清单新建数据集（计数清零）
- 重命名合并：物种重命名/批量重命名若同名会自动合并，计数取最大值
- 物种编辑写库：可选开关控制手动编辑分类/湿重是否写入自定义库；分类编辑弹窗支持“本次写入本机库”
- 批量录入（Excel/语音/文字）：
  - Excel：支持表1.xlsx（浮游动物计数）或简易表（点位/物种/计数）导入到当前数据集
  - 本地解析：改为/增加/减少/删除（点位可用“1号点位/点位1/点位名/当前点”）
  - AI 解析（可选 API1/API2 + 综合/计数模板）：覆盖点位新增/删除/重命名/改 Vc/Vo；物种新增/删除/重命名；计数改/增/减；湿重/分类本机库或 API 补齐（可指定写入库）
  - 语音助手接入：可调用独立语音助手 App（`com.voiceassistant`），回传 raw_text/bulk_json 后自动走 API 解析与纠错校准，并打开预览（Android 11+ 需在主 App Manifest 中声明 `queries` 以可见）
- 语音助手补充：引擎可选 Whisper/Sherpa（流式：zipformer 中文/zipformer bilingual；高精度：sense-voice/paraformer；NNAPI 可开关），Whisper 模型仅保留 `small-q8_0`，多线程线程数可选（自动/1/2/4/6/8），录音格式可选 M4A/WAV，转写结果支持一键清除，音频缓存可一键清除；设置页新增视觉效果开关（毛玻璃/高斯模糊），界面采用玻璃拟态；主 App 全局助手可直接下发模型/模式/加速参数（含 Sherpa 模型选择）
- 全局助手浮窗：半透明贴边按钮（全局可见），单输入框（指令/询问）；长按悬浮按钮录音，上滑=指令/下滑=询问，左右滑可取消；录音无需切换 App，直接调用语音助手后台转写（`ACTION_TRANSCRIBE_AUDIO`），支持取消转写；展开面板支持直接拖动；内置“语音设置”可选引擎/模式/加速/线程数，并支持切换是否下发配置
- 全局助手功能操作：支持打开设置/助手/导出/数据库树/思维导图/别名/AI缓存，预览表1/表2，导出表1/表2，切换手机/平板/自动 UI，检测 API，AI 分析当前数据，点位追溯
- 全局助手询问/数据查询：与助手页“询问 AI”互通，结合当前数据集 + 数据库 + 项目文档/更新日志进行回答；点击询问直接调用 API，失败后自动检测；语音/文本支持模糊纠错；回答在浮窗内以卡片收纳，点击查看全文
- 兼容：支持 action 字段/单键对象/嵌套参数等多种返回格式；多段 JSON 自动选可解析候选；提示词收敛到 type 字段
  - 诊断：支持查看 AI 原始响应，解析结果为 0 时禁用“应用”并提示
  - 纠错：点位/物种名新增“待校准列表”，支持手动选择采用校正或保留原词；点位中文数字与重复“点位”词自动纠正
  - 模糊匹配/歧义项进入“待确认列表”，未解析命令列为“无法解析”
- 图片识别导入（AI）：
  - 支持多图导入或拍照，多张纸也可批量识别
  - 识别点位/物种/计数（支持“1+1”表达式）
  - 物种名支持别名与模糊校正；无法确认会提示
  - 涂改/划掉的无效文字会被忽略
  - 导入到已有数据集时，点位/物种自动合并，计数取手动与导入的最大值
  - 支持“追加到当前数据集”或“新建数据集”，导入后仍可手动增减
- 一键补齐拆分：
  - 补齐分类
  - 补齐湿重
- 平均湿重库：支持多库分开保存与快速切换；物种页可选择当前湿重库；匹配优先内置库
- 分类补齐：支持别名/模糊匹配，避免手动纠错后仍无法命中库
- 先查本机库（内置分类/湿重库/自定义），缺失再调用 API；并记录“本次匹配写入”，可一键撤销
- 可选开关：补齐结果写入本机库（写入自定义分类/湿重库，方便下次直接本机补齐）
- 全屏编辑：每条物种提供“编辑”按钮进入全屏编辑页（避免列表内编辑区域过小）
- 编辑联想：编辑页支持物种名与分类字段关键词联想（从本机库联想并补齐缺失项）
- 编辑写库：编辑页可直接开关“写入本机库”（保存时分类/湿重同步到自定义库）
- 专注录入：右上角入口进入“专注录入（全屏）”

### 2.3 专注录入（全屏）

用途：现场快速录入计数，最大化列表显示空间。

特点：
- 隐藏顶部栏（真全屏），页面内自带返回按钮
- 支持搜索筛选、分组折叠、点位快速切换
- 显示当前点位物种数与计数总和
- 点位按钮显示各点位物种数与计数总和
- 每个物种行提供编辑入口（跳转到全屏编辑页）

### 2.4 AI 监测助手（Tab：助手）

用途：监督录入→计算→导出全流程，提供规则检查、追溯、问答与一键修复缺失项。

支持：
- 手动检测 API：显示 API1/API2 是否可用
- API 可用性：任一接口可用即允许启用 AI；双 API 仅在两者都可用时自动启用
- 本机规则检查（全局监督）：
  - 缺少浓缩体积/原水体积异常/计数为负/缺少大类/缺少湿重/物种名重复等
  - 分级显示：必须修复 / 可忽略 / 提示，并支持一键忽略/恢复
  - 分层一致性检查：同站位不同水深的体积/计数偏离会提示
  - 每条问题支持跳转：去采样点 / 去物种页 / 直接进入物种编辑
- 一键处理缺失项（分类+湿重）：
  - 拆分为：补齐分类 / 补齐湿重
  - 目标：对“有计数但缺分类（类/纲/目/科/属/种）或缺湿重”的物种，优先用本机库补齐；启用 AI 时再用 API1 补齐剩余缺失
  - 会显示本次是否调用 AI（以及 API1 条数统计）
- 点位追溯（一步一步）：生成指定点位的计算过程说明（含核心公式），支持复制与附带到 AI 提问
- 问答：可选双 API；回答提供可复制与“全屏阅读”，并支持自动续写减少截断
- 点位追溯：富文本显示（标题/列表/分数/下标等公式），并增加渲染容错避免闪退
- AI 回答排版：支持标题/列表/表格/有序列表/分数等公式显示，清理 LaTeX 符号（提升可读性）
- AI 监测问答上下文补齐湿重数据，避免提示“无法访问湿重”
- AI 问答上下文补齐项目书/更新日志，便于回答“功能/迭代/使用流程”
- API 检测状态跨页面保留，避免频繁重复检测
- AI 问答与追溯任务支持后台运行，切换页面不清空结果

### 2.5 导出与预览（Tab：导出）

用途：生成 `.xlsx`（含多个 sheet），并提供预览/分享。

支持：
- 表1.xlsx、表2.xlsx 多工作表导出（后台任务 WorkManager，显示进度/失败原因）
- 简表导出：四大类 + 物种简略表（计数/密度/生物量/多样性四个 sheet）
- 导出稳定性：修复表1/表2 空文件与“未知错误”
- 预览：应用内预览表1/表2多个工作表（忽略隐藏列，显示更贴近最终导出）
- 预览体验增强：全屏预览、固定表头、缩放控件（滑条 + 放大/缩小）、预览摘要（条目数/点位数/统计摘要）
- 分享：分别提供两个分享按钮（表1、表2）
- 可选：导出拉丁名开关（类/纲/目/科/属/种；默认全关）；纲/目/科/属可从数据库自定义条目补齐拉丁名
- 统计摘要：点位总计/物种数/优势种清单/缺失湿重一览/数据完整度评分/数据版本
- 数值可读性：采样点汇总/统计摘要使用等宽数字样式并对齐小数位
- 导出元信息：写入分类/湿重/别名库版本与更新时间（Excel 自定义属性）
- 预导出体检：导出页内置 ERROR/WARN 检查 + 一键修复常见问题（点位格式/负数计数/计数结构等）
- 问题提示样式：ERROR/WARN/INFO 图标 + 颜色统一展示
- 校验清单：导出表1/表2/自定义指标时自动生成（可分享）
- 自定义指标导出（CSV）：密度/生物量/H/D/J/Y 可选并排序导出
- 导出前自动生成只读快照（用于回溯）
- 导出清理：自动清理模板残留与隐藏列，空白区域自适应收缩
- 导出优化：临时文件 + SAF 原子写入（避免 0B），大数据流式写出降低内存峰值
- 预览稳定性：合并单元格冲突已修复，预览与导出一致
- 图表：导出页可进入“结果图表”（用于快速核对；不影响 Excel 导出）
- 分析报告（AI）：导出页可生成“浮游动物初步评价”文本报告（可补充采样地点/地理/气候时节等资料；可选 API1 / API2 / 双 API），并导出为 docx
- 计算核对（AI）：内置算法与 API 结果交叉核对；默认用内置，若差异则可选择导出来源；差异用表格示意展示；批量差异审计降低调用次数，失败批次自动拆分/修复，遇限流会提示并停止后续核对；差异明细可导出 CSV
- AI 报告/计算核对支持后台运行，提供进度条与“清除回复/结果”按钮，切换页面不丢结果

### 2.6 平均湿重库（顶部图标：搜索）

用途：快速查看/编辑“平均湿重”数据（内置 + 自定义覆盖）。

说明：
- 显示：内置湿重库 + 自定义覆盖（可切换“仅看自定义覆盖”）
- 同步：在本页或「数据库」页修改湿重，都会同步生效（自动补齐/计算/导出使用最新值）

### 2.7 历史数据集（顶部图标：文件夹）

用途：管理多个数据集、导入导出备份、对比结果差异。

支持：
- 结果对比：选择两个数据集，对比差异点位/差异物种/指数变化
- Excel 导入：支持表1（计数表）与简表（四大类+物种）导入新数据集
- 只读快照：导出表1/表2/自定义指标前自动留存快照，便于回溯
- 只读快照入口：在历史数据集页单独分组，可折叠统一管理
- 整页上下滑动：按钮区与列表区统一可滚动，阅读更清晰
- 操作区/结果区分层：新建/导入/备份集中在顶部，列表与对比在下方
- 分页加载：数据集列表只加载摘要，按需加载更多，减少卡顿

## 3. 数据库（二级页：右上角“数据库”图标）

用途：统一展示并维护：
- 内置分类库
- 内置平均湿重库
- 用户自定义覆盖（可增删改）

支持：
- Excel 导入物种/湿重（规范表 / 3 列层级格式〔兼容表三〕；规范表支持别名列、别名多列与多别名分隔；重复名称自动合并；与内置湿重同名默认保留内置）
- AI 识别导入（输出解析失败时可复制原始输出排查）
- “清空导入平均湿重”（仅删除当前湿重库里导入产生的 custom 湿重，不影响内置湿重库与手动条目）
- 编辑条目：分类字段支持关键词联想
- 编辑条目弹窗：支持上下滑动，避免联想区域遮挡下方字段
- 分类路线图（三级页）：可视化下钻展示分类结构
- 思维导图（三级页）：思维导图式可视化展示分类；双指缩放/拖拽优化防跑飞；支持导出 PNG（自动/4K/8K/12K/16K/20K；内存不足自动降级）/ SVG（矢量），可按大类/纲/目/科/属/种选择或多选同级批量导出

## 4. 设置（二级页：右上角“设置”图标）

包含：
- 默认原水体积（L）
- API1/API2（OpenAI 兼容）：Base URL、Model、Key
- API 管理与快速切换：可保存多个 API 配置，一键应用到 API1/2
- 一键补齐/缺失项处理：补齐结果写入本机库开关（默认关闭）
- 物种编辑写库：手动编辑分类/湿重写入本机库开关
- 视觉效果透明度：玻璃/模糊卡片透明度滑条
- 平板模式（自动/手机/平板）
- AI 功能入口开关：可一键隐藏 AI 相关入口
- 数据与缓存入口：
  - 别名管理：把常用别名映射到标准中文名（用于检索与补齐）
  - AI 缓存：查看/删除/清空 AI 结构化结果缓存（含提示词与原文）
- 日志与诊断：导出关键路径错误日志包、清空日志
- 日志包：导出过程写入日志，便于排查导出失败原因
- 软件信息：版本号、制作人、单位
- 更新日志：每次迭代必须同步更新
- 更新日志支持折叠，避免保存按钮被长日志顶到底部
- 使用流程与核心算法：内置说明（离线可用）
- 项目文档：项目书/当前程序情况/语音助手项目书（离线可读）
- 项目文档访问需密码（本地解密后显示，资源加密）

## 5. 数据流转（录入→计算→导出）

### 5.1 核心对象

- 数据集 Dataset：
  - points（采样点列表）
  - species（物种列表：中文名、拉丁名、分类 Taxonomy、平均湿重、按点位计数映射）
- 数据库覆盖：
- 自定义湿重库（多库；当前库参与补齐与导出）
  - 自定义分类库（custom 覆盖内置表1）
  - 别名映射
  - AI 缓存（结构化结果 + prompt + raw）

### 5.2 关键公式（与指南一致）

- 密度：`density(ind/L) = (n / 1.3) * (Vc / Vo)`
- 生物量：`biomass(mg/L) = density * 湿重(mg/个)`
- Shannon-Wiener（公式3）：`H' = - Σ (p_i * ln p_i)`，`p_i = n_i / N`
- Pielou（公式4）：`J = H' / ln S`（S 为该点位物种数）
- Margalef（公式5）：`D = (S - 1) / ln N`
- 优势度（公式6）：`Y_i = (n_i / N) * f_i`，`f_i = 出现点数 / 总点数`，`Y > 0.02` 视为优势种
- 分层多样性（上/中/下层）：不能对各样品的 H'/D/J 做平均；应先在同一水层内合并原始个体数（n_i 求和），再按公式重新计算。

## 6. 备份与迁移

入口：历史数据集页支持导出/导入 + 一键分享备份。

备份内容（当前）：
- 数据集
- 设置
- 自定义分类覆盖
- 自定义湿重覆盖（含 origin/importBatchId，分库保存）
- 湿重库列表（库名/ID/更新时间）
- 别名
- AI 缓存

说明：
- 备份导入时若数据集 ID 冲突会自动生成新 ID，避免覆盖原数据。
- 备份导入支持“预览与选择性导入”（可只导入数据集/只导入设置/只导入自定义库等）；导出支持可选加密备份（需密码）。

## 7. 代码结构索引（常用文件）

版本与日志：
- `android/app/build.gradle.kts`
- `android/app/src/main/java/com/plankton/one102/ui/AppInfo.kt`
- 最新版本：`6.1`（物种页乱码修复 + 物种页与日志页滚动降载优化）

导航与页面：
- `android/app/src/main/java/com/plankton/one102/ui/PlanktonApp.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/PointsScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/SpeciesScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/FocusCountScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/AssistantScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/PreviewScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/ChartsScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/DatabaseScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/DatabaseTreeScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/DatabaseMindMapScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/SettingsScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/AliasScreen.kt`
- `android/app/src/main/java/com/plankton/one102/ui/screens/AiCacheScreen.kt`

模型与计算：
- `android/app/src/main/java/com/plankton/one102/domain/Models.kt`
- `android/app/src/main/java/com/plankton/one102/domain/Calc.kt`
- `android/app/src/main/java/com/plankton/one102/domain/DataQuality.kt`
- `android/app/src/main/java/com/plankton/one102/domain/DatasetOps.kt`

API 与提示词：
- `android/app/src/main/java/com/plankton/one102/data/api/ChatCompletionClient.kt`
- `android/app/src/main/java/com/plankton/one102/domain/TaxonomyPrompts.kt`
- `android/app/src/main/java/com/plankton/one102/domain/WetWeightPrompts.kt`
- `android/app/src/main/java/com/plankton/one102/data/api/AiSpeciesInfo.kt`
- `android/app/src/main/java/com/plankton/one102/data/api/CalcVerification.kt`
- `android/app/src/main/java/com/plankton/one102/domain/CalcDiff.kt`
- `android/app/src/main/java/com/plankton/one102/data/api/AiImageImport.kt`
- `android/app/src/main/java/com/plankton/one102/importer/ImageImportUtils.kt`

语音助手对接：
- `android/app/src/main/java/com/plankton/one102/voiceassistant/VoiceAssistantContract.kt`
- `android/app/src/main/java/com/plankton/one102/voiceassistant/VoiceAssistantReceiver.kt`
- `android/app/src/main/java/com/plankton/one102/voiceassistant/VoiceAssistantHub.kt`
- `android/app/src/main/java/com/plankton/one102/voiceassistant/VoiceAssistantRecorder.kt`
- `android/app/src/main/java/com/plankton/one102/voiceassistant/VoiceAssistantAudioShare.kt`
- `android/app/src/main/java/com/plankton/one102/voiceassistant/WavUtils.kt`
- `android/app/src/main/java/com/plankton/one102/ui/components/GlobalAssistantOverlay.kt`
- `android/app/src/main/java/com/plankton/one102/ui/dialogs/BatchCountDialog.kt`

Room 数据库：
- `android/app/src/main/java/com/plankton/one102/data/db/AppDatabase.kt`
- `android/app/src/main/java/com/plankton/one102/data/db/WetWeightEntity.kt`
- `android/app/src/main/java/com/plankton/one102/data/db/TaxonomyEntity.kt`
- `android/app/src/main/java/com/plankton/one102/data/db/AliasEntity.kt`
- `android/app/src/main/java/com/plankton/one102/data/db/AiCacheEntity.kt`

## 8. 构建与打包（Windows PowerShell）

```powershell
$env:JAVA_HOME='D:\plankton\.toolchain\jdk\jdk-17.0.13+11'
$env:PATH="$env:JAVA_HOME\bin;$env:PATH"
cd d:\plankton\android
.\gradlew.bat :app:assembleDebug
```

APK 输出：
- `d:\plankton\android\app\build\outputs\apk\debug\app-debug.apk`
- 同时会归档到：`d:\plankton\apk_history\debug\`（按版本号命名）

## 9. 迭代规则（必须遵守）

- 每做一个版本：必须同步更新
  - `android/app/build.gradle.kts` 的 `versionName/versionCode`
  - `android/app/src/main/java/com/plankton/one102/ui/AppInfo.kt` 的更新日志
- 内置湿重库不可删除；只允许删除“导入产生”的自定义湿重覆盖。
- AI 调用使用 OpenAI 兼容接口；尽量双 API 交叉验证；并在 UI 中清晰展示结果来源与可追溯信息。

## 10. 仓库与上传状态（2026-02-12）

### 10.1 Git 与远程仓库

- 远程仓库：`https://github.com/yuelangmanle/plankton.git`
- 主分支：`main`
- Git 提交身份（本仓库）：`yuelangmanle <yuelangmanle@users.noreply.github.com>`

### 10.2 已完成的体积清理

- 历史 APK 清理：
  - 主 App 仅保留：`d:\plankton\apk_history\debug\app-debug-v6.1(610).apk`
  - 语音助手仅保留：`d:\plankton\voice_assistant\apk_history\debug\voice-assistant-debug-v3.2(32).apk`
- 已删除语音助手本地模型目录：
  - `d:\plankton\voice_assistant\app\src\main\assets\models`
  - `d:\plankton\voice_assistant\app\src\main\assets\sherpa`
  - `d:\plankton\voice_assistant\third_party\sherpa`

### 10.3 当前“未上传（本地保留）”的文件类别

以下内容被 `.gitignore` 忽略，不会上传到 GitHub：

- 构建/缓存目录：`.tmp/`、`.toolchain/`、`**/build/`、`**/.gradle/`、`out/`、`node_modules/` 等
- APK/AAB 产物与历史包：`apk_history/`、`voice_assistant/apk_history/`、`*.apk`、`*.aab` 等
- 本地模型目录：`voice_assistant/app/src/main/assets/models/`、`voice_assistant/app/src/main/assets/sherpa/`、`voice_assistant/third_party/sherpa/`
- 表格文件：`*.xlsx`、`*.xls`、`*.csv`、`*.tsv`、`*.xlsm`、`*.ods`

说明：表格文件与部分大体积资产仍在本地磁盘，可用于继续开发；只是从 Git 跟踪和远程上传中剔除。

